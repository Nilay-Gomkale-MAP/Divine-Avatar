<!DOCTYPE html>
<html>
    <head>
        <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
        <script src="https://unpkg.com/aframe-orbit-controls@1.3.2/dist/aframe-orbit-controls.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/aframe-extras@7.6.0/dist/aframe-extras.min.js"></script>
        <style>
            body, html, canvas { margin: 0; overflow: hidden; height: 100%; background-color: transparent !important;}
            
        </style>
    </head>

    <body>
        <a-scene
            renderer="alpha: true;" 
            webxr="mode: ar; requiredFeatures: hit-test; referenceSpaceType: local;"
            xr-mode-ui="enabled: true; XRMode: ar"
            vr-mode-ui="enabled: false"
            ar-hit-test="target:#vahan"
            style="background: transparent;"
        >
        <a-assets>
        <a-asset-item id="vahanModel" src="/vahan_model.glb"></a-asset-item>
        </a-assets>

        <!-- Model entity with animation mixer -->
        <a-entity
        id="vahan"
        gltf-model="#vahanModel"
        position="0 0 -1"
        scale="1 1 1"
        animation-mixer
        visible="true"
        ></a-entity>

        <!-- Reticle is a ring that appears on detected surfaces -->
        <a-ring
            id="reticle"
            radius-inner="0.05"
            radius-outer="0.07"
            color="#39BB82"
            rotation="-90 0 0"
            visible="false"
        ></a-ring>

        <!-- Camera with orbit controls for desktop and non-AR mode -->
        <a-entity 
        camera 
        look-controls="enabled: false"
        orbit-controls="target: 0 0 -1; enableZoom: true; enableRotate: true; enablePan: false; initialPosition: 0 0 1; "
        ></a-entity>

        <!-- Basic lighting -->
        <a-entity light="type: ambient; intensity: 0.8"></a-entity>
        <a-entity light="type: directional; intensity: 1" position="1 2 1"></a-entity>

        <!-- Sky background -->
        <!-- <a-sky color="#ECECEC"></a-sky> -->
        </a-scene>
    </body>
    <script>
        const scene = document.querySelector('a-scene');
        const reticle = document.querySelector('#reticle');
        const model = document.querySelector('#vahan');
        let placed = false;

        // Show reticle when surface is detected
        scene.addEventListener('ar-hit-test-achieved', () => {
            console.log('ar-hit-test-achieved fired');
            if (!placed) reticle.setAttribute('visible', true);
        });

        // Update reticle position and rotation continuously
        scene.addEventListener('ar-hit-test-result', (event) => {
            if (placed) return;
            const {position, rotation} = event.detail;
            console.log('ar-hit-test-result:', position, rotation);
            reticle.setAttribute('position', position);
            reticle.setAttribute('rotation', rotation);
        });

        // Place model at reticle position on tap
        scene.addEventListener('ar-hit-test-select', () => {
            if (!placed) {
                // Place model at reticle position on tap
                placed = true;
                reticle.setAttribute('visible', false);

                // Copy position and rotation from reticle
                const position = reticle.getAttribute('position');
                const rotation = reticle.getAttribute('rotation');

                model.setAttribute('position', position);
                model.setAttribute('rotation', rotation);
                model.setAttribute('visible', true);
            }
        });

        // When entering AR mode, hide model and reset placement
        scene.addEventListener('enter-vr', () => {
            if (scene.is('ar-mode')) {
                placed = false;
                model.setAttribute('visible', false);
                reticle.setAttribute('visible', false);
            }
        });

        // When exiting AR mode, show model again for desktop/canvas
        scene.addEventListener('exit-vr', () => {
            placed = false;
            model.setAttribute('visible', true);
            reticle.setAttribute('visible', false);
        });
    </script>
</html>
