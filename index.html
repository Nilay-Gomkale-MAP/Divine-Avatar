<!DOCTYPE html>
<html>
    <head>
        <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
        <script src="https://unpkg.com/aframe-orbit-controls@1.3.2/dist/aframe-orbit-controls.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/aframe-extras@7.6.0/dist/aframe-extras.min.js"></script>
        <style>
            /* page background: slightly brighter spotlight, vertically centered, ~20% wider radius */
            body, html {
                margin: 0;
                overflow: hidden;
                height: 100%;
                /* center the spotlight vertically (50%), keep brighter inner spot and wider radius */
                background: radial-gradient(circle at 50% 50%, #4a4a4a 0%, #272727 30%, #000 72%) fixed;
            }

            /* let the A-Frame canvas be transparent so the gradient shows through */
            canvas {
                background: transparent !important;
                height: 100%;
            }

            /* hide default A-Frame enter-vr button (we use a custom button) */
            .a-enter-vr-button {
                display: none !important;
            }

            /* custom AR button: white fill, black text, bottom-center */
            #myEnterARButton {
                position: absolute;
                bottom: 40px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(127,127,127,0.25);
                color: #ffffff;
                border: 1px solid rgba(255,255,255,0.25);
                padding: 16px 24px;
                /* border-radius: 4px; */
                font-size: 16px;
                z-index: 10000;
                cursor: pointer;
                /* box-shadow: 0 4px 12px rgba(0,0,0,0.25); */
                -webkit-tap-highlight-color: transparent;
                text-decoration: none;
                font-family: Arial, Helvetica, sans-serif;
            }
            #myEnterVRButton:hover{
                background: #0000ff;
                color: #ffffff;
            }
            #exit-ar {
                position: absolute;
                font-size: 16px;
                right: 40px;
                top: 40px;
                background: #ffffff;
                color: #000000;
                border: 1px solid rgba(255,255,255,0.25);
                padding: 8px 12px;
                font-weight: bold;
            }
        </style>
    </head>

    <body>

        <!-- Overlay Section -->
        <div id="overlay">
            <button id="exit-ar" style="display: none;">Exit AR</button>
        </div>

        <!-- Scene Setup Node -->
        <a-scene
            renderer="alpha: true;" 
            webxr="mode: ar; requiredFeatures: hit-test; referenceSpaceType: local; optionalFeatures: dom-overlay; overlayElement: #overlay"
            xr-mode-ui="enabled: true; XRMode: ar; enterARButton: #myEnterARButton; exitARButton: #myExitARButton;"
            vr-mode-ui="enabled: false"
            style="background: transparent;"
            ar-hit-test="target:#arOnly; enabled: true;">

            <!-- Importing Animated Model Asset -->
            <a-assets>
            <a-asset-item id="ARModel" src="Toy_Dino_animated.glb"></a-asset-item>
            </a-assets>

            <!-- Importing Highres Model Asset -->
            <a-assets>
                <a-asset-item id="pgModel" src="Toy_Dino_highres.glb"></a-asset-item>
            </a-assets>

            <!-- AR Model entity: start invisible so ar-hit-test can place/show it w/ Animation Mixer-->
            <a-entity
            id="arOnly"
            gltf-model="#ARModel"
            position="0 0 -1"
            scale="1.4 1.4 1.4"
            animation-mixer
            visible="false"
            ></a-entity>

            <!-- Web Page only model: No animations and should be set to disappear when changed to AR mode-->
            <a-entity
            id="pageOnly"
            gltf-model="#pgModel"
            position="0 0 -1"
            scale="1.4 1.4 1.4"
            visible="true";
            ></a-entity>

            <!-- Custom AR Entry Buttons-->
            <a-entity id="myEnterARButton" href="#">Click to Start AR</a-entity>
            <a-entity exit-ar-button="element: #exit-ar"></a-entity>
            

            <!-- LEARNING: 
            <a id="myExitARButton" href="#" style="display: none;">Exit AR Mode</a>

            Need to Use DOM Overlay to create an Exit button: 
            https://github.com/immersive-web/dom-overlays/blob/master/explainer.md => 
            This worked and found a better guide: https://github.com/aframevr/aframe/blob/master/examples/boilerplate/webxr-dom-overlay/index.html

            or

            Let's create an new 3D entity which is fixed in the top right corner of the screen,
            and when clicked, it will exit AR mode. => Tried and Failed to figure it out as it became tough to reliably place the Exit button in the top right corner
            -->
            
            <!-- Camera with orbit controls for desktop and non-AR mode -->
            <a-entity
            camera
            look-controls="enabled: false"
            orbit-controls="target: 0 0.25 -1; enableZoom: true; enablePan: false; initialPosition: 0 0.5 -0.2; rotateSpeed: 1; zoomSpeed: 1.2; minDistance: 0.25; maxDistance: 2.5; autoRotate: true"
            ></a-entity>

            <!-- IDEA WHILE TESTING:
            We can parent a fixed image to the camera like done above to make some creative frames that make enhance the experience, 
            this way we can take advantage of fixed elements to insert text, clues and more to create an interesting experience
            -->

            <!-- Basic lighting -->
            <a-entity light="type: ambient; intensity: 0.8"></a-entity>
            <a-entity light="type: directional; intensity: 1" position="1 2 1"></a-entity>
        </a-scene>
    </body>
    
    <script>
        AFRAME.registerComponent('ar-mode-manager', {
        init: function () {
            const sceneEl = this.el;
            const pageModel = document.querySelector('#pageModel');
            const arModel = document.querySelector('#arModel');
            const camera = document.querySelector('#camera');
            const entryBtn = document.querySelector('#entryBtn');
            const exitBtn = document.querySelector('#exitBtn');

            let placed = false;
            let initialPosition, initialQuaternion;

            pageModel.addEventListener('model-loaded', () => {
            initialPosition = pageModel.object3D.position.clone();
            initialQuaternion = pageModel.object3D.quaternion.clone();
            });

            entryBtn.addEventListener('click', () => {
            sceneEl.renderer.xr.enabled = true;
            sceneEl.enterVR();
            console.log("AR entry requested");
            });

            exitBtn.addEventListener('click', () => {
            console.log("Exit AR button pressed");
            sceneEl.exitVR();
            });

            sceneEl.addEventListener('enter-vr', () => {
            if (sceneEl.is('ar-mode')) {
                pageModel.setAttribute('visible', 'false');
                arModel.setAttribute('visible', 'true');
                exitBtn.style.display = 'block';
                entryBtn.style.display = 'none';
                placed = false;
                startHitTest();
            }
            });

            sceneEl.addEventListener('exit-vr', () => {
            const xrSession = sceneEl.renderer.xr.getSession();
            if (xrSession) {
                xrSession.addEventListener('end', () => {
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                    placed = false;
                    pageModel.setAttribute('visible', 'true');
                    arModel.setAttribute('visible', 'false');
                    arModel.object3D.position.copy(initialPosition);
                    arModel.object3D.quaternion.copy(initialQuaternion);

                    camera.setAttribute('look-controls', 'enabled', false);
                    camera.setAttribute('orbit-controls', 'enabled', true);

                    pageModel.setAttribute('position', '0 0 -1');
                    pageModel.setAttribute('scale', '1.4 1.4 1.4');

                    entryBtn.style.display = 'block';
                    exitBtn.style.display = 'none';

                    stopHitTest();
                    console.log('âœ… Restored page model safely after AR exit');

                    // ðŸ”§ Force renderer reset
                    const rendererSystem = sceneEl.systems.renderer;
                    if (rendererSystem && rendererSystem.renderer) {
                        rendererSystem.renderer.xr.setSession(null);
                        rendererSystem.renderer.setAnimationLoop(null);
                        rendererSystem.renderer.clear();
                        console.log("ðŸ”„ Renderer reset after AR session");
                    }
                    });
                });
                });
            }
            });
        }
        });
    </script>
 </html>
